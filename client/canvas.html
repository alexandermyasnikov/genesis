<!doctype html>
<html>
  <head>
    <title>Genesis</title>
    <meta charset='utf-8' />
    <style>
      #canvas {
        // width:100%;
        // height:100%;
      }
      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <canvas id='canvas'></canvas>
    <script>
      {
        var width = 600;
        var height = 600;
        var address = "192.168.0.103:8000";
        var url_world = "http://" + address + "/genesis/world";
        var revision_config = -1;
        var revision_world = 0;
        var sleep = 1000;
        var x0 = 0;
        var y0 = 0;
        var w = 0;
        var h = 0;
        var scale = 0;
        var world;
        var cell_ind = -1;
        var mode = "normal";

        function mod(n, m) {
          return ((n % m) + m) % m;
        }

        var getJSON = function(url, callback) {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.responseType = 'json';
          xhr.onload = function() {
            callback(xhr.status, xhr.response);
          };
          xhr.send();
        };

        function update() {
          getJSON(url_world + "?revision=" + revision_world,
            function(status, data) {
              if (status == 200) {
                world = data;
                draw_world();
              } else if (status == 304) {
                ;
              } else {
                console.log('status: ' + status);
              }
            });
        }

        function draw_world() {
          revision_world = world.revision;

          if (revision_config < world.config.revision) {
            revision_config = world.config.revision;
            w = world.config.position_n;
            h = world.config.position_max / world.config.position_n;
            x0 = 0;
            y0 = 0;
          }

          w = Math.min(w, world.config.position_n);
          h = Math.min(h, world.config.position_max / world.config.position_n);
          x0 = Math.max(x0, 0);
          y0 = Math.max(y0, 0);
          x0 = Math.min(x0, world.config.position_n - w);
          y0 = Math.min(y0, (world.config.position_max / world.config.position_n) - h);

          scale_n = width / w;
          scale_m = height / h;
          scale = Math.min(scale_n, scale_m);

          ctx.resetTransform();
          ctx.fillStyle = "rgba(240, 240, 240, 1)";
          ctx.fillRect(0, 0, width, height);
          ctx.scale(scale, scale);
          ctx.translate(-x0, -y0);

          for (const key in world.cells) {
            const cell = world.cells[key];
            let x = Math.floor(cell.pos % world.config.position_n);
            let y = Math.floor(cell.pos / world.config.position_n);
            let color = "rgba(100, 100, 100, 0.8)";
            if (cell.type == "producer") {
              color = "rgba(0, 180, 0, 0.8)";
            } else if (cell.type == "spore") {
              color = "rgba(180, 0, 0, 0.8)";
            }

            if (x >= x0 - 1
              && x <= x0 + h + 1
              && y >= y0 - 1
              && y <= y + h + 1)
            {
              ctx.fillStyle = color;
              let delta = 0.05;
              ctx.fillRect(x + delta, y + delta, 1 - 2 * delta, 1 - 2 * delta);
            }
          }

          for (const key in world.bacterias) {
            const bacteria = world.bacterias[key];
            let x = Math.floor(bacteria.pos % world.config.position_n);
            let y = Math.floor(bacteria.pos / world.config.position_n);
            let color = "rgba(0, 0, 100, 0.8)";

            if (x >= x0 - 1
              && x <= x0 + h + 1
              && y >= y0 - 1
              && y <= y + h + 1)
            {
              let delta = 0.2;
              ctx.fillStyle = color;
              ctx.beginPath();
              ctx.arc(x + 0.5, y + 0.5, 0.5 - delta, 0, 2 * Math.PI);
              ctx.fill()
            }
          }

          {
            const cell = world.cells[cell_ind];
            if (cell) {
              let cell_json = JSON.stringify(cell, null, 2);
              console.log(cell_json);
            }
          }

          {
            const bacteria = world.bacterias[cell_ind];
            if (bacteria) {
              let bacteria_json = JSON.stringify(bacteria, null, 2);
              console.log(bacteria_json);
            }
          }

          {
            ctx.save()
            ctx.resetTransform();
            ctx.font = "20px Arial";
            ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
            let t_scale = Math.floor(scale);
            let t_x0 = Math.floor(x0);
            let t_y0 = Math.floor(y0);
            let t_x1 = Math.floor(t_x0 + w);
            let t_y1 = Math.floor(t_y0 + h);
            text = [
              "scale:    " + t_scale,
              "window:   " + t_x0 + " " + t_y0 + " " + t_x1 + " " + t_y1,
              "age:      " + world.stats.age,
              "mode:     " + mode,
            ];
            for (const i in text) {
              ctx.fillText(text[i], 10, 20 + 22 * i);
            }
            ctx.restore();
          }
        }

        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext('2d');
        canvas.width  = width;
        canvas.height = height;

        canvas.addEventListener('mousemove', e => {
          var rect = canvas.getBoundingClientRect();
          var x = e.clientX - rect.left;
          var y = e.clientY - rect.top;
          x = Math.floor(x0 + x / scale);
          y = Math.floor(y0 + y / scale);
          var ind = y * world.config.position_n + x;
          if (cell_ind != ind) {
            cell_ind = ind;
            draw_world();
          }
        });

        window.addEventListener('keydown', e => {
          if (e.key == "ArrowUp") {
            y0 -= 0.1 * h;
            draw_world();
          } else if (e.key == "ArrowDown") {
            y0 += 0.1 * h;
            draw_world();
          } else if (e.key == "ArrowLeft") {
            x0 -= 0.1 * w;
            draw_world();
          } else if (e.key == "ArrowRight") {
            x0 += 0.1 * w;
            draw_world();
          } else if (e.key == "+") {
            const dx = 0.2 * w;
            const dy = 0.2 * h;
            x0 += dx / 2;
            y0 += dy / 2;
            w -= dx;
            h -= dy;
            draw_world();
          } else if (e.key == "-") {
            const dx = 0.2 * w;
            const dy = 0.2 * h;
            x0 -= dx / 2;
            y0 -= dy / 2;
            w += dx;
            h += dy;
            draw_world();
          }
        });

        update();
        setInterval(update, sleep);
      }
    </script>
  </body>
</html>
